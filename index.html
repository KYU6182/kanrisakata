<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>物件管理オーナーApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #lightbox { transition: opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-24">

    <div id="app">
        <!-- Header -->
        <header class="bg-white border-b sticky top-0 z-30 px-4 py-3 shadow-sm">
            <div class="flex flex-col gap-3">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-black text-blue-900 flex items-center gap-2">
                        <i data-lucide="building-2" class="text-blue-600"></i>
                        オーナーApp
                    </h1>
                    <div id="sync-status" class="flex items-center gap-2 bg-green-50 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold border border-green-100">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                        同期中
                    </div>
                </div>
                
                <div id="property-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <!-- JSで動的に生成 -->
                </div>
            </div>
        </header>

        <main class="max-w-md mx-auto p-4">
            <!-- Main Tabs -->
            <div class="flex bg-slate-200/60 p-1.5 rounded-2xl mb-6 backdrop-blur-sm">
                <button onclick="switchTab('cleaning')" id="tab-cleaning" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-black transition-all bg-white text-blue-700 shadow-md">
                    <i data-lucide="camera" class="w-4 h-4"></i>
                    巡回清掃
                </button>
                <button onclick="switchTab('report')" id="tab-report" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-black transition-all text-slate-500">
                    <i data-lucide="clipboard-check" class="w-4 h-4"></i>
                    作業報告書
                </button>
            </div>

            <!-- List View -->
            <div id="list-view" class="space-y-8 pb-10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i data-lucide="archive" class="w-4 h-4"></i>
                        <span class="text-xs font-black tracking-widest uppercase">Archive</span>
                    </div>
                    <button onclick="showAddForm()" class="bg-blue-600 text-white w-14 h-14 rounded-2xl shadow-xl shadow-blue-200 flex items-center justify-center active:scale-90 transition-transform">
                        <i data-lucide="plus" class="w-8 h-8"></i>
                    </button>
                </div>
                <div id="records-container" class="space-y-6">
                    <!-- JSでデータ表示 -->
                </div>
            </div>

            <!-- Form View -->
            <div id="form-view" class="hidden bg-white rounded-3xl shadow-xl border border-slate-100 p-6 animate-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="form-title" class="text-lg font-black flex items-center gap-2 text-slate-800">新規作成</h2>
                    <button onclick="hideAddForm()" class="bg-slate-100 p-2 rounded-full text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <form id="report-form" class="space-y-5">
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">実施年月日</label>
                        <input type="date" id="form-date" class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none" required>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">報告・連絡内容</label>
                        <textarea id="form-content" rows="5" class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 font-medium outline-none resize-none" placeholder="作業内容を入力..." required></textarea>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl">
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">現場写真 (最大10枚)</label>
                            <span id="photo-count" class="text-[9px] font-bold text-slate-400">0/10</span>
                        </div>
                        <div id="photo-preview-grid" class="grid grid-cols-3 gap-3">
                            <label id="add-photo-btn" class="aspect-square flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-xl bg-white hover:bg-blue-50 transition-all cursor-pointer">
                                <i data-lucide="camera" class="text-slate-400"></i>
                                <span class="text-[9px] text-slate-500 mt-1 font-bold">追加</span>
                                <input type="file" id="file-input" accept="image/*" multiple class="hidden">
                            </label>
                        </div>
                        <p id="size-warning" class="hidden text-[10px] text-red-500 mt-2 font-bold">⚠️ 容量制限のためこれ以上追加できません</p>
                    </div>
                    <button type="submit" id="submit-btn" class="w-full py-4 rounded-2xl font-black text-white shadow-xl bg-blue-600 active:scale-95 transition-all">報告書を送信する</button>
                </form>
            </div>
        </main>

        <!-- Lightbox -->
        <div id="lightbox" class="hidden fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-4" onclick="closeLightbox(event)">
            <button onclick="closeLightbox(event)" class="absolute top-6 right-6 text-white bg-white/20 p-4 rounded-full backdrop-blur-xl border border-white/20 z-[110] active:scale-90 transition-transform">
                <i data-lucide="x" class="w-7 h-7 pointer-events-none"></i>
            </button>
            <div class="w-full h-full flex items-center justify-center relative pointer-events-none">
                <button onclick="prevPhoto(event)" class="absolute left-0 h-full w-16 flex items-center justify-start pl-2 text-white/40 hover:text-white pointer-events-auto z-[105]">
                    <i data-lucide="chevron-left" class="w-10 h-10"></i>
                </button>
                
                <!-- 写真本体をタップしても閉じるように onclick を設定 -->
                <img id="lightbox-img" src="" onclick="closeLightbox(event)" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl pointer-events-auto z-[102] cursor-pointer">
                
                <button onclick="nextPhoto(event)" class="absolute right-0 h-full w-16 flex items-center justify-end pr-2 text-white/40 hover:text-white pointer-events-auto z-[105]">
                    <i data-lucide="chevron-right" class="w-10 h-10"></i>
                </button>
            </div>
            <div id="lightbox-counter" class="text-white/60 text-xs font-bold tracking-widest mt-4 z-[105] pointer-events-none">1 / 1</div>
        </div>

        <!-- 削除確認モーダル -->
        <div id="delete-modal" class="hidden fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl animate-in">
                <div class="text-center">
                    <div class="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="trash-2" class="text-red-500 w-8 h-8"></i>
                    </div>
                    <h3 class="text-lg font-black text-slate-800 mb-2">報告を削除しますか？</h3>
                    <p class="text-xs text-slate-400 font-medium mb-6">この操作は取り消せません。</p>
                    <div class="flex gap-3">
                        <button onclick="closeDeleteModal()" class="flex-1 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl active:scale-95 transition-all">キャンセル</button>
                        <button id="confirm-delete-btn" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg shadow-red-200 active:scale-95 transition-all">削除する</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Property Badge -->
        <div class="max-w-md mx-auto px-4 mt-6 pb-20">
            <div class="bg-slate-900 rounded-[2.5rem] p-6 text-white shadow-2xl relative overflow-hidden">
                <div class="relative z-10 flex items-center gap-4">
                    <div class="bg-blue-600 p-3 rounded-2xl"><i data-lucide="map-pin"></i></div>
                    <div>
                        <h4 id="badge-name" class="font-black text-lg">イーハトーヴＫＮ</h4>
                        <p id="badge-address" class="text-[10px] text-white/50 font-medium tracking-tight">福岡県筑紫野市美しが丘北１丁目6-16</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Nav -->
        <nav class="fixed bottom-0 inset-x-0 bg-white/80 backdrop-blur-xl border-t border-slate-100 px-8 py-4 flex justify-between items-center z-40">
            <div class="flex flex-col items-center gap-1.5"><div class="bg-blue-600 text-white p-2 rounded-xl"><i data-lucide="building-2" class="w-5 h-5"></i></div><span class="text-[9px] font-black text-blue-600 uppercase">Properties</span></div>
            <div class="flex flex-col items-center gap-1.5 opacity-30"><i data-lucide="image" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase">Gallery</span></div>
            <div class="flex flex-col items-center gap-1.5 opacity-30"><i data-lucide="archive" class="w-5 h-5"></i><span class="text-[9px] font-black uppercase">Documents</span></div>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, Timestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAbuCJXFHo7AV-VDYVGNQ6LdOPEeDyaglE",
            authDomain: "ihatoobu.firebaseapp.com",
            projectId: "ihatoobu",
            storageBucket: "ihatoobu.firebasestorage.app",
            messagingSenderId: "914171761832",
            appId: "1:914171761832:web:3d4e5a2374bae7a6d51e9d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "ihatoobu-mgmt-final";

        const PROPERTIES = [
            { id: 'kn', name: 'イーハトーヴＫＮ', address: '福岡県筑紫野市美しが丘北１丁目6-16' },
            { id: 'tajima', name: 'ARTTY田島', address: '福岡県福岡市城南区田島2丁目11-18' }
        ];

        let state = {
            activeProperty: PROPERTIES[0],
            activeTab: 'cleaning',
            records: [],
            tempPhotos: [],
            lightboxPhotos: [],
            lightboxIndex: 0,
            deleteTargetId: null
        };

        window.onload = async () => {
            lucide.createIcons();
            document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
            await signInAnonymously(auth);
            renderPropertyTabs();
            listenToData();
        };

        function renderPropertyTabs() {
            const container = document.getElementById('property-tabs');
            container.innerHTML = PROPERTIES.map(p => `
                <button onclick="switchProperty('${p.id}')" class="flex-shrink-0 px-4 py-2.5 rounded-xl text-xs font-bold transition-all ${state.activeProperty.id === p.id ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-500 border border-slate-200'}">
                    ${p.name}
                </button>
            `).join('');
        }

        window.switchProperty = (id) => {
            state.activeProperty = PROPERTIES.find(p => p.id === id);
            document.getElementById('badge-name').innerText = state.activeProperty.name;
            document.getElementById('badge-address').innerText = state.activeProperty.address;
            renderPropertyTabs();
            hideAddForm();
            listenToData();
        };

        window.switchTab = (tab) => {
            state.activeTab = tab;
            document.getElementById('tab-cleaning').className = tab === 'cleaning' ? 'flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-black transition-all bg-white text-blue-700 shadow-md' : 'flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-black transition-all text-slate-500';
            document.getElementById('tab-report').className = tab === 'report' ? 'flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-black transition-all bg-white text-blue-700 shadow-md' : 'flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-black transition-all text-slate-500';
            hideAddForm();
            listenToData();
        };

        let unsubscribe = null;
        function listenToData() {
            if (unsubscribe) unsubscribe();
            const collectionName = `${state.activeTab === 'cleaning' ? 'cleaning_logs' : 'work_reports'}_${state.activeProperty.id}`;
            const q = collection(db, 'artifacts', appId, 'public', 'data', collectionName);
            unsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (b.date || "").localeCompare(a.date || ""));
                renderRecords(records);
            });
        }

        function renderRecords(records) {
            const container = document.getElementById('records-container');
            if (records.length === 0) {
                container.innerHTML = `<div class="bg-white border-2 border-dashed border-slate-200 rounded-3xl p-12 text-center text-slate-400 font-bold">記録がありません</div>`;
                return;
            }
            const grouped = records.reduce((acc, r) => {
                const month = (r.date || "").substring(0, 7) || "不明";
                if (!acc[month]) acc[month] = [];
                acc[month].push(r);
                return acc;
            }, {});
            container.innerHTML = Object.keys(grouped).map(month => `
                <div class="space-y-4">
                    <div class="flex items-center gap-3"><span class="text-sm font-black text-slate-800 bg-slate-200 px-3 py-1 rounded-lg">${month.replace('-', '年')}月</span><div class="flex-1 h-[2px] bg-slate-100"></div></div>
                    ${grouped[month].map(r => `
                        <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm relative">
                            <!-- 削除ボタン -->
                            <button onclick="confirmDelete('${r.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>

                            <div class="flex justify-between items-start mb-3 pr-8">
                                <div><div class="text-[10px] text-slate-400 font-black tracking-wider uppercase">${r.date}</div><div class="font-black text-slate-800 text-sm">${state.activeTab === 'cleaning' ? '定期巡回・清掃' : '保守メンテナンス'}</div></div>
                                <div class="text-green-500"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                            </div>
                            <p class="text-sm text-slate-600 mb-4 whitespace-pre-wrap font-medium leading-relaxed">${r.content}</p>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                ${(r.photos || []).map((p, idx) => `
                                    <img src="${p}" onclick="window.openLightbox(${JSON.stringify(r.photos).replace(/"/g, '&quot;')}, ${idx})" class="w-24 h-24 rounded-2xl object-cover flex-shrink-0 border shadow-sm cursor-pointer active:scale-95 transition-transform">
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- 削除ロジック ---
        window.confirmDelete = (id) => {
            state.deleteTargetId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
        };

        window.closeDeleteModal = () => {
            document.getElementById('delete-modal').classList.add('hidden');
            state.deleteTargetId = null;
        };

        document.getElementById('confirm-delete-btn').onclick = async () => {
            if (!state.deleteTargetId) return;
            const collectionName = `${state.activeTab === 'cleaning' ? 'cleaning_logs' : 'work_reports'}_${state.activeProperty.id}`;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', collectionName, state.deleteTargetId);
            try {
                await deleteDoc(docRef);
                closeDeleteModal();
            } catch (err) {
                alert("削除に失敗しました");
            }
        };

        window.showAddForm = () => {
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('form-view').classList.remove('hidden');
            document.getElementById('form-title').innerText = state.activeTab === 'cleaning' ? '新規清掃報告' : '新規作業報告書';
        };

        window.hideAddForm = () => {
            document.getElementById('list-view').classList.remove('hidden');
            document.getElementById('form-view').classList.add('hidden');
            state.tempPhotos = [];
            renderPhotoPreview();
        };

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                if (state.tempPhotos.length >= 10) { // 10枚に拡張
                    alert("写真は最大10枚までです");
                    break;
                }
                const compressed = await compressImage(file);
                const currentTotalSize = state.tempPhotos.reduce((acc, p) => acc + p.length, 0);
                if (currentTotalSize + compressed.length > 950000) { 
                    document.getElementById('size-warning').classList.remove('hidden');
                    break;
                }
                state.tempPhotos.push(compressed);
                renderPhotoPreview();
            }
            e.target.value = '';
        });

        // 10枚送るために圧縮をさらに強化 (600px / 0.4品質)
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const MAX = 600; // 800から600に縮小
                        if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
                        else if (h > MAX) { w *= MAX / h; h = MAX; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.4)); // 品質を0.4に
                    };
                };
            });
        }

        function renderPhotoPreview() {
            const grid = document.getElementById('photo-preview-grid');
            const addBtn = document.getElementById('add-photo-btn');
            const countLabel = document.getElementById('photo-count');
            const previews = grid.querySelectorAll('.photo-item');
            previews.forEach(p => p.remove());

            state.tempPhotos.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = "photo-item relative aspect-square rounded-xl overflow-hidden border shadow-sm";
                div.innerHTML = `
                    <img src="${p}" class="w-full h-full object-cover">
                    <button type="button" onclick="removeTempPhoto(${i})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md"><i data-lucide="x" class="w-3 h-3"></i></button>
                `;
                grid.insertBefore(div, addBtn);
            });
            countLabel.innerText = `${state.tempPhotos.length}/10`;
            if (state.tempPhotos.length >= 10) addBtn.classList.add('hidden');
            else addBtn.classList.remove('hidden');
            document.getElementById('size-warning').classList.add('hidden');
            lucide.createIcons();
        }

        window.removeTempPhoto = (i) => {
            state.tempPhotos.splice(i, 1);
            renderPhotoPreview();
        };

        document.getElementById('report-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const totalSize = state.tempPhotos.reduce((acc, p) => acc + p.length, 0);
            if (totalSize > 1000000) {
                alert("データの容量が大きすぎます。写真を減らしてください。");
                return;
            }
            btn.innerText = "送信中...";
            btn.disabled = true;
            const collectionName = `${state.activeTab === 'cleaning' ? 'cleaning_logs' : 'work_reports'}_${state.activeProperty.id}`;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), {
                    date: document.getElementById('form-date').value,
                    content: document.getElementById('form-content').value,
                    photos: state.tempPhotos,
                    createdAt: Timestamp.now()
                });
                btn.innerText = "送信完了！";
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "報告書を送信する";
                    document.getElementById('report-form').reset();
                    hideAddForm();
                }, 1000);
            } catch (err) {
                alert("送信に失敗しました");
                btn.disabled = false;
                btn.innerText = "報告書を送信する";
            }
        };

        window.openLightbox = (photos, idx) => {
            state.lightboxPhotos = photos;
            state.lightboxIndex = idx;
            updateLightbox();
            document.getElementById('lightbox').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.closeLightbox = (event) => {
            // イベントの伝播を防ぐ必要なし、どこをタップしても閉じる
            document.getElementById('lightbox').classList.add('hidden');
            document.body.style.overflow = '';
        };

        window.nextPhoto = (event) => {
            if (event) event.stopPropagation();
            state.lightboxIndex = (state.lightboxIndex + 1) % state.lightboxPhotos.length;
            updateLightbox();
        };

        window.prevPhoto = (event) => {
            if (event) event.stopPropagation();
            state.lightboxIndex = (state.lightboxIndex - 1 + state.lightboxPhotos.length) % state.lightboxPhotos.length;
            updateLightbox();
        };

        function updateLightbox() {
            document.getElementById('lightbox-img').src = state.lightboxPhotos[state.lightboxIndex];
            document.getElementById('lightbox-counter').innerText = `${state.lightboxIndex + 1} / ${state.lightboxPhotos.length}`;
        }
    </script>
</body>
</html>